name: CD - Deploy to Vercel

on:
  workflow_run:
    workflows: ["CI - Build & Test"]
    types:
      - completed
    branches: [main]

  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

env:
  DOTNET_VERSION: '9.0.x'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  # Re-run build and tests to ensure latest code is validated
  validate:
    name: Validate Build & Tests
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Run tests
        run: dotnet test --no-restore --configuration Release --verbosity normal

      - name: Publish for deployment
        run: dotnet publish TestAI.Web/TestAI.Web.csproj --configuration Release --output ./publish

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: ./publish
          retention-days: 1

  # Manual approval gate before deployment
  approval:
    name: Deployment Approval
    runs-on: ubuntu-latest
    needs: validate
    environment:
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

    steps:
      - name: Approval checkpoint
        run: |
          echo "## Deployment Approved" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment to Vercel has been approved by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY

  # Deploy to Vercel after approval
  deploy:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: approval
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Publish Blazor app
        run: dotnet publish TestAI.Web/TestAI.Web.csproj --configuration Release --output ./publish

      - name: Prepare for Vercel deployment
        run: |
          # Copy wwwroot content to output directory for static hosting
          cp -r ./publish/wwwroot/* ./publish/ 2>/dev/null || true

          # Create vercel.json in publish folder if not exists
          if [ ! -f "./publish/vercel.json" ]; then
            cp ./vercel.json ./publish/ 2>/dev/null || echo '{"routes":[{"handle":"filesystem"},{"src":".*","dest":"/index.html"}]}' > ./publish/vercel.json
          fi

      - name: Pull Vercel environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./publish

      - name: Build for Vercel
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
        working-directory: ./publish

      - name: Deploy to Vercel
        id: deploy
        run: |
          url=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
          echo "url=$url" >> $GITHUB_OUTPUT
          echo "## Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** $url" >> $GITHUB_STEP_SUMMARY
        working-directory: ./publish

      - name: Post deployment notification
        run: |
          echo "Deployment completed successfully!"
          echo "URL: ${{ steps.deploy.outputs.url }}"

  # Deployment failed notification
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [validate, deploy]
    if: failure()

    steps:
      - name: Create failure summary
        run: |
          echo "## Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment pipeline failed. Please check the logs for more details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
